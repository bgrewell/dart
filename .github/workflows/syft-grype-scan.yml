name: Syft SBOM and Grype Vulnerability Scan

on:
  # Manual trigger
  workflow_dispatch:
  # Trigger on tagged pushes
  push:
    tags:
      - 'v*'
      - '*.*.*'

permissions:
  contents: write
  security-events: write

jobs:
  syft-grype-scan:
    name: Syft SBOM & Grype Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
      
      # Install Syft for SBOM generation
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0.17.9
      
      # Install Grype for vulnerability scanning
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin
      
      # Generate SBOM in multiple formats using Syft
      - name: Generate SBOM with Syft (CycloneDX JSON)
        run: |
          syft dir:. -o cyclonedx-json=sbom-cyclonedx.json
      
      - name: Generate SBOM with Syft (SPDX JSON)
        run: |
          syft dir:. -o spdx-json=sbom-spdx.json
      
      - name: Generate SBOM with Syft (Human-readable)
        run: |
          syft dir:. -o table > SBOM.txt
      
      # Scan for vulnerabilities using Grype
      - name: Run Grype vulnerability scanner (SARIF)
        run: |
          grype sbom:sbom-cyclonedx.json -o sarif > grype-results.sarif
      
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'grype-results.sarif'
      
      - name: Run Grype vulnerability scanner (JSON)
        run: |
          grype sbom:sbom-cyclonedx.json -o json > grype-results.json
      
      - name: Run Grype vulnerability scanner (Human-readable VEX)
        run: |
          grype sbom:sbom-cyclonedx.json -o table > VEX.txt
      
      - name: Publish Grype Output to Summary
        run: |
          set -euo pipefail
          if [[ -f VEX.txt && -s VEX.txt ]]; then
            {
              echo "## üîç Grype Vulnerability Scan Results"
              echo ""
              echo "<details><summary>Click to expand full report</summary>"
              echo ""
              echo '```'
              cat VEX.txt
              echo '```'
              echo "</details>"
            } >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚úÖ Grype Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Publish SBOM to Summary
        run: |
          set -euo pipefail
          if [[ -f SBOM.txt && -s SBOM.txt ]]; then
            {
              echo "## üì¶ Software Bill of Materials (SBOM)"
              echo ""
              echo "<details><summary>Click to expand SBOM</summary>"
              echo ""
              echo '```'
              head -n 100 SBOM.txt
              echo '```'
              echo "</details>"
            } >> $GITHUB_STEP_SUMMARY
          fi
      
      # Commit SBOM.txt and VEX.txt to repository
      - name: Commit SBOM and VEX files to repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add SBOM.txt VEX.txt
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update SBOM.txt and VEX.txt from Syft and Grype scan"
            git push
          fi
      
      - name: Upload Grype vulnerability scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: grype-vulnerability-reports
          path: |
            grype-results.sarif
            grype-results.json
            VEX.txt
          retention-days: 90
      
      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sbom-reports
          path: |
            sbom-cyclonedx.json
            sbom-spdx.json
            SBOM.txt
          retention-days: 90
